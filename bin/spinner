#!/bin/bash
# shellcheck disable=SC2034
((def_spinner)) && return 0 || def_spinner=1
sp1='\|/â€’'
sp2='âºâ»â¼â½_â½â¼â»'
sp3='â•¸â•¹â•ºâ•»'
sp4='â—´â—·â—¶â—µ'
sp5='â—°â—³â—²â—±'
sp6='â—¸â—¹â—¿â—º'
sp7='â˜°â˜±â˜²â˜³â˜´â˜µâ˜¶â˜·'
sp8='â‹®â‹°â‹¯â‹±'
sp9='â¨‚â¨'
sp10='ä·—ä·†ä·ä·ä·‡ä·–'
sp11='âŒŒâŒâŒâŒ'
sp12='ï‰€ï‰ï‰‚ï‰ƒï‰„ï‰ƒï‰‚ï‰'
sp13='âŒœâŒâŒŸâŒ'
sp14='â•¯â•°â•­â•®'
sp15='â–â–â–â–Œâ–‹â–Šâ–‰â–ˆâ–‰â–Šâ–‹â–Œâ–â–â–'
sp16='î•°î•µî•´î•³î•²î•³î•´î•µ'
sp17='î•»î•ºî•¹î•¸î•¹î•º'
sp18='â£¾â£½â£»â¢¿â¡¿â£Ÿâ£¯â£·'
sp19='â â ƒâ ‡â¡‡â¡†â¡„â¡€ â¡„â¡†â¡‡â ‡â ƒâ  '
sp20='â â ‚â „â¡€ '
sp21='ášáš‚ášƒáš„áš…ášŠáš‰ášˆáš‡áš† '
sp22='áš‹ášŒášášášášášášŒáš‹ '
sp23='ášáš‘áš’áš“áš”áš“áš’áš‘áš '
sp24='â––â–—â–â–˜'
sp25='â–™â–Ÿâ–œâ–›'
sp26='â«â¬â­â®â¯'
sp27='î…¾î…¿î†€î†î†‚î†ƒî†„î†…î††î†…î†„î†ƒî†‚î†î†€î…¿î…¾'
sp28='ï‹‡ï‹ˆï‹‰ï‹Šï‹‹ï‹Šï‹‰ï‹ˆ'
sp29='ğŸ§ğŸ´ğŸºğŸ¿ğŸºğŸ´'
sp30='â®Œâ®â®â®'
sp31='â–â–‚â–ƒâ–„â–…â–†â–‡â–ˆâ–‰â–Šâ–‹â–Œâ–â–â–â–â–â–‹â–Šâ–‰â–ˆâ–‡â–†â–…â–„â–ƒâ–‚â–'
sp32='ï‰‘ï‰’ï‰“'
sp33='ğŒ†ğŒ‡ğŒŠğŒ“ğŒ®ğŒ¯ğŒ²ğŒ»ğ–ğ•ğ’ğ‰ğŒ®ğŒ­ğŒªğŒ¡'
sp34='ğŸ¡ ğŸ¡¤ğŸ¡¡ğŸ¡¥ğŸ¡¢ğŸ¡¦ğŸ¡£ğŸ¡§'
#
function _spinner() {
    # $1 start/stop
    #
    # on start: $2 display message
    # on stop : $2 process exit status
    #           $3 spinner function pid (supplied from stop_spinner)

	if [ -z "$on_success" ];then
	    local on_success="DONE"
	fi
   	if [ -z "$on_fail" ];then
    	local on_fail="FAIL"
    fi
    local white="\e[1;37m"
    local green="\e[1;32m"
    local red="\e[1;31m"
    local nc="\e[0m"

    case $1 in
        start)
            # calculate the column where spinner and status msg will be displayed
            let column=$(tput cols)-${#2}-8
            # display message and position the cursor in $column column
            echo -ne "${2}"
            printf "%${column}s"

            # start spinner
            i=1
            if [ -z "$sp" ];then
       			sp='â–â–‚â–ƒâ–„â–…â–†â–‡â–ˆâ–‡â–†â–…â–„â–ƒâ–‚â–'
       		fi
            delay=${SPINNER_DELAY:-0.15}
            while true;do
            	let column1=$(tput cols)-${#2}-8
            	if [ $column -ne $column1 ];then
	            	for (( i=0; i<column; i++ ));do
	            		printf "\b"
	            	done
	            	let column=$(tput cols)-${#2}-8
	            	echo -ne "${2}"
	            	printf "%${column}s"
	            fi
                printf '\b\b\b[%s]' "${sp:$((i++))%${#sp}:1}"
                sleep "$delay"
            done
            ;;
        stop)
            if [[ -z ${3} ]]; then
                echo "spinner is not running.."
                exit 1
            fi

            kill "$3" > /dev/null 2>&1

            # inform the user uppon success or failure
            echo -en "\b\b\b["
            if [[ $2 -eq 0 ]]; then
                echo -ne "${green}${on_success}${nc}"
            else
                echo -ne "${red}${on_fail}${nc}"
            fi
            echo -e "]"
            ;;
        *)
            echo "invalid argument, try {start/stop}"
            exit 1
            ;;
    esac
}

function start_spinner {
    # $1 : msg to display
    _spinner "start" "${1}" &
    # set global spinner pid
    _sp_pid=$!
    disown
}

function stop_spinner {
    # $1 : command exit status
    _spinner "stop" "$1" $_sp_pid
    unset _sp_pid
}
