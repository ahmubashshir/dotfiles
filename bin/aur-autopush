#!/bin/bash
# shellcheck disable=SC2181,SC1091,SC2034
pypi:pkgver()
{
	curl -s "https://pypi.org/pypi/$1/json" | jq -r '.info.version'
}
github:pkgver()
{
	curl -sH "Accept: application/vnd.github.v3+json" "https://${2:-api.github.com}/repos/$1/tags" | jq -r 'if (.[]|length)>0 then .[0].name, halt else null end|.|=sub("v(?<ver>.*)";"\(.ver)")'
}
gitlab:pkgver()
{
	curl -s "https://${2:-gitlab.com}/api/v4/projects/${1//\//%2F}/repository/tags" | jq -r 'if (.[]|length)>0 then .[0].name, halt else null end|.|=sub("v(?<ver>.*)";"\(.ver)")'
}
py:deps()
{
	local -a overrides
	overrides=(
		-e 's/pygobject/gobject/'
	)
	sed -E "${overrides[@]}"
}
pip:deps()
{
	sed -En "s/^([[:alnum:]]+)==([[:digit:].]+)\.\*,>=([[:digit:].]+)(|; sys_platform == \"linux\")$/python-\1<\2\npython-\1>=\3/p" \
		| awk -F '<|\\.' '$0 ~ /<.*[[:digit:]]$/{print $1"<"$NF+1".0.0"};$0 !~ /<.*[[:digit:]]$/' \
		| py:deps
}
poetry:deps()
{
	dephell deps convert \
		--from pyproject.toml \
		--to-format=pip \
		--to-path=stdout 2> /dev/null | pip:deps
}
pypi:deps()
{
	curl -s "https://pypi.org/pypi/$1/json" \
		| jq -r '.info.requires_dist[]?' \
		| sed -En \
			's/^([[:alnum:]]+)\s*\(>=([[:digit:].]+),<([[:digit:].]+)\)(|; sys_platform == \"linux\")$/python-\1<\3\npython-\1>=\2/p' \
		| py:deps
}
use_vpn()
{
	local p
	test -n "$USE_VPN" || return 0
	[ "$1" = "c" ] || p="dis"
	echo -ne "vpn: ${p}connecting   \r"
	false
	until (($? == 0)); do
		windscribe "${p}connect" 2>&1 > /dev/null
	done
	echo "vpn: ${p}connected   "
}
#if ! netcat -zw3 aur.archlinux.org ssh && test -n "$(which --skip-functions --skip-alias windscribe)";then
#	USE_VPN=true
#fi
if (($# == 0)); then
	set -- ./*/
elif [[ $1 == --stdin ]]; then
	shift
	while read -r line; do
		set -- "$@" "$line"
	done
fi
for n in "$@"; do
	repo="$(git -C "$n" rev-parse --show-toplevel 2> /dev/null)"
	if readlink "$repo/.git/hooks/prepare-commit-msg" 2> /dev/null \
		| grep -q '/aurpublish/' \
		|| test -f "$repo/.aurpublish"; then
		aurpublish=true
	else
		aurpublish=false
	fi
	unset repo
	if [ -f "$n/PKGBUILD" ] && [ ! -e "$n/WIP" ]; then
		(
			typeset -a exclude
			pkgver=0
			pkgrel=0
			cd "$n" 2>&1 > /dev/null || exit
			git stash -- . 2>&1 > /dev/null
			use_vpn c
			git pull
			use_vpn d
			git stash apply 2>&1 > /dev/null
			git stash drop 2>&1 > /dev/null
			source ./PKGBUILD
			srcdir=src
			if grep -m 1 -q '^# pkg:' PKGBUILD; then
				type=$(awk '/^# pkg: /{print $3}' PKGBUILD)
				src=$(awk '/^# pkg: /{print $4}' PKGBUILD)
				provider=$(awk '/^# pkg: / && NF > 4 {print $5}' PKGBUILD)
				case $type in
					bzr | git | hg | svn)
						makepkg -o -d --skipchecksums
						PKGVER=$(pkgver)
						;;
					*)
						if [ "$(type -t "$type:pkgver")" = "function" ]; then
							PKGVER=$("$type:pkgver" "${src:-${_name:-${pkgbase:-$pkgname}}}" "$provider")
						else
							PKGVER=0
						fi
						;;
				esac
				if [ "$(vercmp ${PKGVER:-0} $pkgver)" = "1" ]; then
					sed -Ei "s/^(pkgver=)(\"|'|)$pkgver(\"|'|)$/\1\2$PKGVER\3/g;s/^(pkgrel)=.*/\1=1/g" PKGBUILD
					msg="[${src:-${_name:-${pkgbase:-$pkgname}}}] Updated to $PKGVER-1"
				fi
				for dep in ${type} ${src} ${provider}; do
					if
						type -t ${dep}:deps 2> /dev/null \
							| grep -wq function
					then
						depfunc=$dep
						unset dep
						break
					fi
				done
				if [[ -n $depfunc ]]; then
					makepkg --nobuild
					sed -Ei.bak '/^depends=\(/,/\)/{/#auto-deps$/d}' PKGBUILD
					(
						for dir in ${pkgname}-${pkgver} ${_name} ${pkgname%*-git}; do
							if test -d "src/$dir"; then
								cd "src/$dir"
								break
							fi
						done
						"${depfunc}:deps" "${src}"
					) | while read -r line; do
						sed -Ei.bak "/^depends=\(/,/\)/{s@^\)\$@\t'$line' #auto-deps\n\)@}" PKGBUILD
					done
					unset depfunc
				fi
			fi
			echo updating checksums
			updpkgsums -m
			if [ -n "$(git status --porcelain)" ] || [ "${FORCE_REL_BUMP+defined}" ] && [ "$FORCE_REL_BUMP" != "false" ]; then
				if [ -z "$PKGVER" ] || [ "$(vercmp $PKGVER $pkgver)" = "0" ]; then
					sed -Ei "s/^(pkgrel=)[[:digit:]]+$/\1$((pkgrel + 1))/" PKGBUILD
					msg="[${src:-${_name:-${pkgbase:-$pkgname}}}] pkgrel bump."
				fi
				[ -f ../.nopush ] && msg='nopush: '"${msg:-automatic commmit.}"
				if [ "$aurpublish" = "false" ]; then
					makepkg --printsrcinfo > .SRCINFO
				fi
				git add .
				git commit -m "${msg:-automatic push.}"
			fi
			if git status --porcelain --branch | grep -q ahead && {
				[ ! -f ../.nopush ] || [ "${SKIP_PUSH+defined}" ] && [ "$SKIP_PUSH" != "false" ]
			}; then
				use_vpn c
				git push
				if $aurpublish; then
					aurpublish $PWD
				fi
				use_vpn d
			fi
			exclude+=(
				-e '*.log'
				-e 'PKGBUILD.bak'
				-e '.no*'
			)
			for src in "${source[@]}"; do
				src=${src%%::*}
				src=${src##*/}
				if [ -e "$src" ]; then
					exclude+=('-e' "${src}")
				fi
			done
			fakeroot rm -rf src pkg
			git clean -fxd "${exclude[@]}" .
		)
	fi
done
